## カスタマイズ・ガイド(1)
### IRServerの仕組み
#### リモコンの構成情報</br>
cl51.htmを使って説明します

- リモコンの定義ファイル（/フォルダに保存）

![](/DOC/cl51htm.png)

- 使用する画像とボタン情報（/S/フォルダに保存）</br>
リモコンに使用する画像(cl5.jpg)とボタン情報(cl5.txt)がペアとなる

![](/DOC/cl5btn.png)

- 使用するリモコン信号情報（/D/フォルダに保存）</br>
ボタンを押すことによって送出される赤外線信号をリモコンデータファイル（/IRdata.txt）に保存しています、このファイルの元になる操作対象機器ごとの学習データを保存するファイルです。</br>
リモコン画面起動時に「map\_start」で指定された開始位置からリモコンデータファイルに書き写されます。</br>
開始位置が指定されない場合は、直前の情報（最初であれば10）に続く番号になります。</br>
画面起動時の学習データの書き写しは、リモコンデータファイルの内容が異なっている場合にのみ行います。

![](/DOC/IRdatatxt.png)

#### リモコンの動作
1. リモコン画像とその画像上のボタン情報をリモコン操作端末（スマホなどのブラウザ）に表示させる。
2. リモコン画像上のボタンが押されるとボタン情報（(x, y)-(x+w, y+h)の矩形領域）からのボタン番号と
ボタン情報開始番号から送出するボタン番号を決定し、その番号をESPに通知します。
照明やＴＶなどの単純なリモコンの場合は、番号を通知するだけですが、エアコンのように状況情報を組み合わせて信号を生成する場合は、
機器の状態と押されたボタンの組合せで送出信号を変化させることが必要になります。
この信号の内容変更はリモコン操作端末側に送り込んだJavascript（/D/acMitsubishi\_xxx.jsなど）側で生成します。</br>
（このために状況に応じて送出するデータが変化するリモコンは単純に学習することができないことになります）

3. ESP側では、操作画面から通知された情報番号に対応した信号を送出します。
- 単純なリモコンの場合：</br>
例）「ON」：照明を全灯でオンにする</br>
ブラウザ：赤外線データ「125」を通知</br>
ESP：'84519A65'を赤外線信号として送出</br>

- エアコンの場合：</br>
例）「UP」：温度を上げる</br>
ブラウザ：「225」のデータを下記のような変更指示を付加して通知</br>
  data[14] = (data[14] & 0x0F) | 0x14</br>
  data[15] = (data[15] & 0xCF) | 0x20</br>
   ..</br>
   ..</br>
  data[21] = sum(data[4]..data[20])</br>
ESP：情報番号に対応するデータを変更指示に従って変更して赤外線信号として送出
